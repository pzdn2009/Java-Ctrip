# 理论

## 1. CAP

CAP\(Consistency, Availability, Partition Tolerance\).

Consistency\(一致性\), 数据一致更新，所有数据变动都是同步的 Availability\(可用性\), 好的响应性能 Partition tolerance\(分区容忍性\) 可靠性

定理：任何分布式系统只可同时满足二点，没法三者兼顾。 忠告：架构师不要将精力浪费在如何设计能满足三者的完美分布式系统，而是应该进行取舍。 ![](https://res.infoq.com/articles/solution-of-distributed-system-transaction-consistency/zh/resources/000.png)

BASE\(Basically avaliable, soft state, eventually consistent\): 是分布式事务实现的一种理论标准

事务补偿机制: 在事务链中的任何一个正向事务操作, 都必须存在一个完全符合回滚规则的可逆事务.

幂等性: 简单的说, 业务操作支持重试, 不会产生不利影响. 常见的实现方式: 为消息额外增加唯一ID.

## 2. 2PC

两阶段提交：发出通知，得到回复。

两阶段提交\(Two Phase Commit, 2PC\), 具有强一致性, 是CP系统的一种典型实现.

缺点

两阶段提交中的第二阶段, 协调者需要等待所有参与者发出yes请求, 或者一个参与者发出no请求后, 才能执行提交或者中断操作. 这会造成长时间同时锁住多个资源, 造成性能瓶颈, 如果参与者有一个耗时长的操作, 性能损耗会更明显.

实现复杂, 不利于系统的扩展, 不推荐.

## 3. 本地消息表

```sql
transaction begin

update...
insert into message ... 

commit
end
```

## 3. ACID

3.1、原子性（A） 所谓的原子性就是说，在整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态。对于事务在执行中发生错误，所有的操作都会被回滚，整个事务就像从没被执行过一样。

3.2、一致性（C） 事务的执行必须保证系统的一致性，就拿转账为例，A有500元，B有300元，如果在一个事务里A成功转给B50元，那么不管并发多少，不管发生什么，只要事务执行成功了，那么最后A账户一定是450元，B账户一定是350元。

3.3、隔离性（I） 所谓的隔离性就是说，事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知。

3.4、持久性（D） 所谓的持久性，就是说一单事务完成了，那么事务对数据所做的变更就完全保存在了数据库中，即使发生停电，系统宕机也是如此。

## 4. XA协议

![](http://static.codeceo.com/images/2016/07/distri-trans-03.png)

## 5. 事务类型

柔性事务 vs. 刚性事务

刚性事务是指严格遵循ACID原则的事务, 例如单机环境下的数据库事务.

柔性事务是指遵循BASE理论的事务, 通常用在分布式环境中, 常见的实现方式有: 两阶段提交\(2PC\), TCC补偿型提交, 基于消息的异步确保型, 最大努力通知型.

通常对本地事务采用刚性事务, 分布式事务使用柔性事务.

Ref：[http://blog.csdn.net/congyihao/article/details/70195154](http://blog.csdn.net/congyihao/article/details/70195154)

## 5. TCC

优点： TCC能够对分布式事务中的各个资源进行分别锁定, 分别提交与释放, 例如, 假设有AB两个操作, 假设A操作耗时短, 那么A就能较快的完成自身的try-confirm-cancel流程, 释放资源. 无需等待B操作. 如果事后出现问题, 追加执行补偿性事务即可.

TCC是绑定在各个子业务上的\(除了cancle中的全局回滚操作\), 也就是各服务之间可以在一定程度上”异步并行”执行.

## 6. 最大努力通知型

这是分布式事务中要求最低的一种, 也可以通过消息中间件实现, 与前面异步确保型操作不同的一点是, 在消息由MQ Server投递到消费者之后, 允许在达到最大重试次数之后正常结束事务.

## 7. Saga

